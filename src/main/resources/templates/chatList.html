<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>채팅 페이지</title>
    <style>
        li {
            border: 1px solid black;
        }
        img {
            width: 50px;
            height: 50px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            var socket = new WebSocket("ws://localhost:8087/chat");

            socket.onopen = function() {
                console.log("WebSocket 연결 성공");
            };

            socket.onmessage = function(event) {
                console.log("WebSocket 메시지 수신:", event.data);
                var message = JSON.parse(event.data);
                appendMessage(message);
            };
            function appendMessage(message) {
                var messageElement = $('<div class="message"></div>');
                messageElement.text(message);
                chatWindow.append(messageElement);
            }

            socket.onerror = function(error) {
                console.error("WebSocket 에러:", error);
            };

            socket.onclose = function() {
                console.log("WebSocket 연결 종료");
            };

            $("#chatForm").submit(function(event) {
                event.preventDefault();

                var message = $("input[name='message']").val();
                var seller = $("#chatWindow").find("p:contains('Seller')").text().split(': ')[1];
                var title = $("#chatWindow").find("p:contains('Title')").text().split(': ')[1];

                var chatMessageDto = {
                    message: message,
                    seller: seller,
                    title: title
                };

                socket.send(JSON.stringify(chatMessageDto));

                $("input[name='message']").val("");
            });
        });
    </script>
    <script th:inline="javascript">
        $(document).ready(function() {
            var chatList = $('.chat-item');
            var chatWindow = $('#chatWindow');

            chatList.each(function() {
                $(this).on('click', function() {
                    var seller = $(this).data('seller');
                    var title = $(this).data('title');
                    var price = $(this).data('price');
                    var imageSrc = $(this).data('imageSrc');

                    chatWindow.html(`
                    <div>
                        <img id="productImage" src="${imageSrc}" alt="Product Image" style="width: 100px; height: 100px;">
                        <p>Seller: ${seller}</p>
                        <p>Title: ${title}</p>
                        <p>Price: ${price}</p>
                    </div>
                `);

                    $('#productImage').attr('src', imageSrc);
                });
            });
        });
    </script>
</head>
<body>

<h1>채팅 페이지</h1>

<!-- 상품 정보 표시 -->

<!-- 채팅 목록 -->
<h2>채팅 목록</h2>
<ul>
    <li class="chat-item" th:each="chat : ${chats}"
        th:data-seller="${chat.seller}"
        th:data-title="${chat.title}"
        th:data-price="${chat.product.getPrice()}"
        th:data-image-src="@{'/images/' + ${chat.product.getImagePath()}}">
        <span th:text="${chat.seller}"></span>: <span th:text="${chat.title}"></span>: <span th:text="${chat.product.getPrice()}"></span>
        <img th:src="@{'/images/' + ${chat.product.getImagePath()}}" alt="Product Image" th:data-image-src="@{'/images/' + ${chat.product.getImagePath()}}" />
    </li>
</ul>

<!-- 채팅 창 -->
<h2>채팅 창</h2>
<div id="chatWindow"></div>
<form id="chatForm" method="POST" action="/sendChat" enctype="multipart/form-data">
    <input type="text" name="message" placeholder="채팅을 입력하세요" required />
    <input type="file" name="file" />
    <button type="submit">전송</button>
</form>

</body>
</html>